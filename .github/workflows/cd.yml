name: CD Workflow

on:
  push:
    branches:
      - main
      - '*'
    paths:
      - "src/agent/chatbot_db/**"   # â† ì—¬ê¸° ë‚´ë¶€ íŒŒì¼ì´ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

jobs:
  deploy:
    name: Deploy Vector DB Update
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Docker ë¡œê·¸ì¸
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      # 3ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and Push Docker image
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

          # ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t knu-chatbot:latest .
          docker tag knu-chatbot:latest knuknuckle/knu-chatbot:latest
          docker push knuknuckle/knu-chatbot:latest

      # 4ï¸âƒ£ EC2ì— SSH ì ‘ì† í›„ ë°°í¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # 1. ğŸ” ì¸ì¦ì„œ ê²½ë¡œ ë³€ìˆ˜ ì •ì˜ (EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ ê²½ë¡œ)
            CERT_PATH=/etc/letsencrypt/live/knuckle.shipfriend.dev
            
            # ìµœì‹  ì´ë¯¸ì§€ pull
            sudo docker pull knuknuckle/knu-chatbot:latest

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ/ì‚­ì œ
            sudo docker stop knu-chatbot || true
            sudo docker rm knu-chatbot || true

            # ì¢…ë£Œëœ ëª¨ë“  ì»¨í…Œì´ë„ˆ ì •ë¦¬
            sudo docker container prune -f
            # í•„ìš” ì—†ëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            sudo docker image prune -f

            # ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # sudo docker run -d -p 80:80 --name knu-chatbot knuknuckle/knu-chatbot:latest
            sudo docker run -d \
            --name knu-chatbot \
            -p 443:443 \
            -v ${CERT_PATH}/privkey.pem:/app/privkey.pem \
            -v ${CERT_PATH}/fullchain.pem:/app/fullchain.pem \
            knuknuckle/knu-chatbot:latest \
            /app/.venv/bin/uvicorn src.api.main:app --host 0.0.0.0 --port 443 \
            --ssl-keyfile /app/privkey.pem \
            --ssl-certfile /app/fullchain.pem
